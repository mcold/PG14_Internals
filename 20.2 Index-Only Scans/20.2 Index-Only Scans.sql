------------------------------------------
-- 20.2 Index-Only Scans
------------------------------------------

EXPLAIN 
  SELECT book_ref 
    FROM bookings 
   WHERE book_ref < '100000';

/*
QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
----------------------------------------------------------------------------------------
Index Only Scan using bookings_pkey on bookings  (cost=0.43..4170.40 rows=146398 width=7)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
  Index Cond: (book_ref < '100000'::bpchar) 
*/

-- The cost estimation of an index-only scan depends on the fraction of all-visible pages in the heap. PostgreSQL  collects such statistics: 

SELECT
    relpages,
    relallvisible
FROM
    pg_class
WHERE
    relname = 'bookings';
/*
relpages   | relallvisible 
??????????+??????????????? 
13447      | 13446
*/

-- Since in this particular example all pages contain only all-visible tuples, the cost of heap I/O is in fact excluded from the cost estimation:
WITH costs (
    idx_cost,
    tbl_cost
) AS ( SELECT ( 
         SELECT round( current_setting('random_page_cost')::real * pages 
                        + current_setting('cpu_index_tuple_cost')::real * tuples 
                        + current_setting('cpu_operator_cost')::real * tuples ) FROM ( SELECT relpages * 0.0630 AS pages, reltuples * 0.0630 AS tuples 
                                                                                         FROM pg_class WHERE relname = 'bookings_pkey' )c ) AS idx_cost,
    ( SELECT round( (1 - frac_visible)  -- fraction of non-all-visible pages 
                    * current_setting('seq_page_cost')::real * pages 
                    + current_setting('cpu_tuple_cost')::real * tuples ) FROM ( SELECT relpages * 0.0630 AS pages, reltuples * 0.0630 AS tuples, relallvisible::real/relpages::real AS frac_visible 
                                                                                  FROM pg_class 
                                                                                 WHERE relname = 'bookings' )c ) AS tbl_cost )
SELECT
    idx_cost,
    tbl_cost,
    idx_cost + tbl_cost AS total
FROM
    costs;
/*
idx_cost    | tbl_cost   | total 
??????????+??????????+??????? 
2457        |  1330      | 3787
*/

-- In a newly created table, Postgre???has to check visibility of all the tuples:
CREATE TEMP TABLE bookings_tmp WITH (autovacuum_enabled = off) AS
    SELECT
        *
    FROM
        bookings
    ORDER BY
        book_ref;

ALTER TABLE bookings_tmp ADD PRIMARY KEY(book_ref); 
ANALYZE bookings_tmp; 

explain (
    analyze,
    timing  off,
    summary off
) SELECT book_ref FROM bookings_tmp WHERE book_ref < '100000';
/*
QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
------------------------------------------------------------------------------------------------------------------------------
Index Only Scan using bookings_tmp_pkey on bookings_tmp  (cost=0.43..4418.89 rows=126655 width=7) (actual rows=132109 loops=1)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
  Index Cond: (book_ref < '100000'::bpchar)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  Heap Fetches: 132109  
*/