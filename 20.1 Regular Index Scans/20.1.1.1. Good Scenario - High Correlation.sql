 -------------------------------------------
-- 20.1.1.1. Good Scenario: High Correlation
--------------------------------------------
EXPLAIN
    SELECT
        *
    FROM
        bookings
    WHERE
            book_ref = '9AC0C6'
        AND total_amount = 48500.00;
        
/*
Index Scan using bookings_pkey on bookings  (cost=0.43..8.45 rows=1 width=21)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
  Index Cond: (book_ref = '9AC0C6'::bpchar)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
  Filter: (total_amount = 48500.00)
*/


SELECT attname, 
       correlation 
  FROM pg_stats 
 WHERE tablename = 'bookings' 
 ORDER BY abs(correlation) DESC;
 
/*
book_ref	    1.0
book_date	    -0.005308329
total_amount	0.003424347
*/

EXPLAIN 
  SELECT * 
    FROM bookings 
   WHERE book_ref < '100000';
/*
QUERY PLAN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- 
Index Scan using bookings_pkey on bookings  (cost=0.43..5106.40 rows=146398 width=21)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
  Index Cond: (book_ref < '100000'::bpchar) 
*/

-- The condition’s selectivity is estimated as follows:
SELECT round(146398::numeric/reltuples::numeric, 4) 
  FROM pg_class 
 WHERE relname = 'bookings';
 
/*
0.0630
*/


WITH costs (
    idx_cost,
    tbl_cost
) AS ( 
      SELECT ( 
              SELECT round( current_setting('random_page_cost')::real * pages + current_setting('cpu_index_tuple_cost')::real * tuples + current_setting('cpu_operator_cost')::real * tuples ) 
                FROM (SELECT relpages * 0.0630 AS pages, reltuples * 0.0630 AS tuples 
                        FROM pg_class 
                       WHERE relname = 'bookings_pkey' )c ), 
                       (SELECT round( current_setting('seq_page_cost')::real * pages + current_setting('cpu_tuple_cost')::real * tuples)
                          FROM(
                               SELECT
                                    relpages * 0.0630     AS pages,
                                    reltuples * 0.0630    AS tuples
                                FROM
                                    pg_class
                                WHERE
                                    relname = 'bookings') c
                        ) 
      )
SELECT
    idx_cost,
    tbl_cost,
    idx_cost + tbl_cost AS total
FROM
    costs;
/*
idx_cost    | tbl_cost  | total
??????????+??????????+????????
2457.0	     2177.0	     4634.0
*/
